{% include "postgresql/server/{0}_pg_hba.conf".format(pillar['postgresql']['version']) %}
{% set date = salt['cmd.run']('date') %}

# The following was auto-generated by SaltStack on {{ date }}

{%- for auth_user, auth_config in pillar.get('postgresql.hba').iteritems() %}
  {%- for auth_item in auth_config %}
    {%- if "addresses" in auth_item %}
      {%- for address in auth_item["addresses"] %}
{{ auth_item["type"] }} {{ auth_item["databases"]|join(',') }} {{ auth_user }} {{ address }} {{ auth_item["method"] }}
      {%- endfor %}
    {%- else %}
{{ auth_item["type"] }} {{ auth_item["databases"]|join(',') }} {{ auth_user }} {{ auth_item["method"] }}
    {%- endif %}
  {%- endfor %}
{%- endfor %}
